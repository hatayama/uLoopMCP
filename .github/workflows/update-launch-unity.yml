name: Update launch-unity dependency

on:
  repository_dispatch:
    types: [launch-unity-released]
  workflow_dispatch:
    inputs:
      version:
        description: 'Target version of launch-unity (empty = latest from npm)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependency:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: ðŸ” Resolve versions
        id: version
        run: |
          # Priority: dispatch payload â†’ workflow_dispatch input â†’ npm latest
          NEW_VERSION="${{ github.event.client_payload.version }}"
          if [ -z "$NEW_VERSION" ]; then
            NEW_VERSION="${{ github.event.inputs.version }}"
          fi
          if [ -z "$NEW_VERSION" ]; then
            NEW_VERSION=$(npm view launch-unity version)
          fi
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          # Get current versions from both package.json files
          CLI_VERSION=$(node -p "require('./Packages/src/Cli~/package.json').dependencies['launch-unity']")
          SERVER_VERSION=$(node -p "require('./Packages/src/TypeScriptServer~/package.json').dependencies['launch-unity']")
          echo "cli_version=$CLI_VERSION" >> "$GITHUB_OUTPUT"
          echo "server_version=$SERVER_VERSION" >> "$GITHUB_OUTPUT"

          echo "ðŸ“‹ Current: Cli~=$CLI_VERSION, Server~=$SERVER_VERSION â†’ Target: $NEW_VERSION"

      - name: âœ… Check if update is needed
        id: check
        run: |
          NEW="${{ steps.version.outputs.new_version }}"
          CLI="${{ steps.version.outputs.cli_version }}"
          SERVER="${{ steps.version.outputs.server_version }}"
          # Skip if both are already up to date
          if [ "$NEW" = "$CLI" ] && [ "$NEW" = "$SERVER" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Both packages already at $NEW â€” skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Update needed: Cli~=$CLI, Server~=$SERVER â†’ $NEW"
          fi

      - name: ðŸ“¦ Update Cli~ dependency
        if: steps.check.outputs.skip == 'false'
        working-directory: Packages/src/Cli~
        run: npm install launch-unity@${{ steps.version.outputs.new_version }} --save-exact

      - name: ðŸ“¦ Update TypeScriptServer~ dependency
        if: steps.check.outputs.skip == 'false'
        working-directory: Packages/src/TypeScriptServer~
        run: npm install launch-unity@${{ steps.version.outputs.new_version }} --save-exact

      - name: ðŸ“ Fetch CHANGELOG diff
        if: steps.check.outputs.skip == 'false'
        run: |
          CLI="${{ steps.version.outputs.cli_version }}"
          NEW="${{ steps.version.outputs.new_version }}"

          # Fetch CHANGELOG.md from launch-unity repo
          CHANGELOG=$(gh api repos/hatayama/LaunchUnityCommand/contents/CHANGELOG.md \
            --jq '.content' | base64 -d) || CHANGELOG=""

          if [ -n "$CHANGELOG" ]; then
            # Extract entries between current and new version
            DIFF=$(echo "$CHANGELOG" | sed -n "/^## .*${NEW}/,/^## .*${CLI}/p" | head -n -1)
            if [ -z "$DIFF" ]; then
              DIFF="Could not extract CHANGELOG diff. Please check the release page."
            fi
          else
            DIFF="Could not fetch CHANGELOG. Please check the release page."
          fi

          # Write to file to avoid multiline output escaping issues
          echo "$DIFF" > /tmp/changelog-diff.txt
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“ Prepare PR body
        if: steps.check.outputs.skip == 'false'
        run: |
          {
            echo "Automated update triggered by launch-unity release."
            echo ""
            echo "## Changes"
            echo "- Update \`launch-unity\` to \`${{ steps.version.outputs.new_version }}\`"
            echo "- Cli~ was at \`${{ steps.version.outputs.cli_version }}\`"
            echo "- TypeScriptServer~ was at \`${{ steps.version.outputs.server_version }}\`"
            echo ""
            echo "## CHANGELOG (launch-unity ${{ steps.version.outputs.cli_version }} â†’ ${{ steps.version.outputs.new_version }})"
            echo ""
            cat /tmp/changelog-diff.txt
            echo ""
            echo "---"
            echo "Release: https://github.com/hatayama/LaunchUnityCommand/releases/tag/launch-unity-v${{ steps.version.outputs.new_version }}"
          } > /tmp/pr-body.md

      - name: ðŸš€ Create Pull Request
        if: steps.check.outputs.skip == 'false'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: deps/update-launch-unity-${{ steps.version.outputs.new_version }}
          commit-message: "chore(deps): bump launch-unity to ${{ steps.version.outputs.new_version }}"
          title: "chore(deps): bump launch-unity to ${{ steps.version.outputs.new_version }}"
          body-path: /tmp/pr-body.md
          labels: dependencies,npm
