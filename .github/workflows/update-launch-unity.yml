name: Update launch-unity dependency

on:
  repository_dispatch:
    types: [launch-unity-released]
  workflow_dispatch:
    inputs:
      version:
        description: 'Target version of launch-unity (empty = latest from npm)'
        required: false
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  update-dependency:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'

      - name: ðŸ” Resolve versions
        id: version
        env:
          DISPATCH_VERSION: ${{ github.event.client_payload.version }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          # Priority: dispatch payload â†’ workflow_dispatch input â†’ npm latest
          NEW_VERSION="$DISPATCH_VERSION"
          if [ -z "$NEW_VERSION" ]; then
            NEW_VERSION="$INPUT_VERSION"
          fi
          if [ -z "$NEW_VERSION" ]; then
            NEW_VERSION=$(npm view launch-unity version)
          fi

          # Validate semver format (stable + pre-release allowed, no build metadata)
          if ! [[ "$NEW_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $NEW_VERSION"
            exit 1
          fi

          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          # Get current versions from both package.json files
          CLI_VERSION=$(node -p "require('./Packages/src/Cli~/package.json').dependencies['launch-unity']")
          SERVER_VERSION=$(node -p "require('./Packages/src/TypeScriptServer~/package.json').dependencies['launch-unity']")
          echo "cli_version=$CLI_VERSION" >> "$GITHUB_OUTPUT"
          echo "server_version=$SERVER_VERSION" >> "$GITHUB_OUTPUT"

          echo "ðŸ“‹ Current: Cli~=$CLI_VERSION, Server~=$SERVER_VERSION â†’ Target: $NEW_VERSION"

      - name: âœ… Check if update is needed
        id: check
        env:
          NEW: ${{ steps.version.outputs.new_version }}
          CLI: ${{ steps.version.outputs.cli_version }}
          SERVER: ${{ steps.version.outputs.server_version }}
        run: |
          # Skip if both are already up to date
          if [ "$NEW" = "$CLI" ] && [ "$NEW" = "$SERVER" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Both packages already at $NEW â€” skipping."
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
            echo "Update needed: Cli~=$CLI, Server~=$SERVER â†’ $NEW"
          fi

      - name: ðŸ“¦ Update Cli~ dependency
        if: steps.check.outputs.skip == 'false'
        working-directory: Packages/src/Cli~
        env:
          TARGET_VERSION: ${{ steps.version.outputs.new_version }}
        run: npm install "launch-unity@${TARGET_VERSION}" --save-exact

      - name: ðŸ“¦ Update TypeScriptServer~ dependency
        if: steps.check.outputs.skip == 'false'
        working-directory: Packages/src/TypeScriptServer~
        env:
          TARGET_VERSION: ${{ steps.version.outputs.new_version }}
        run: npm install "launch-unity@${TARGET_VERSION}" --save-exact

      - name: ðŸ“ Fetch CHANGELOG diff
        if: steps.check.outputs.skip == 'false'
        env:
          CLI_VERSION: ${{ steps.version.outputs.cli_version }}
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch CHANGELOG.md from launch-unity repo
          CHANGELOG=$(gh api repos/hatayama/LaunchUnityCommand/contents/CHANGELOG.md \
            --jq '.content' | base64 -d) || CHANGELOG=""

          if [ -n "$CHANGELOG" ]; then
            # Escape dots for sed regex so semver dots match literally
            NEW_ESCAPED=$(printf '%s' "$NEW_VERSION" | sed 's/\./\\./g')
            CLI_ESCAPED=$(printf '%s' "$CLI_VERSION" | sed 's/\./\\./g')
            DIFF=$(echo "$CHANGELOG" | sed -n "/^## .*${NEW_ESCAPED}/,/^## .*${CLI_ESCAPED}/p" | head -n -1)
            if [ -z "$DIFF" ]; then
              DIFF="Could not extract CHANGELOG diff. Please check the release page."
            fi
          else
            DIFF="Could not fetch CHANGELOG. Please check the release page."
          fi

          # Write to file to avoid multiline output escaping issues
          echo "$DIFF" > /tmp/changelog-diff.txt

      - name: ðŸ“ Prepare PR body
        if: steps.check.outputs.skip == 'false'
        env:
          NEW_VERSION: ${{ steps.version.outputs.new_version }}
          CLI_VERSION: ${{ steps.version.outputs.cli_version }}
          SERVER_VERSION: ${{ steps.version.outputs.server_version }}
        run: |
          {
            echo "Automated update triggered by launch-unity release."
            echo ""
            echo "## Changes"
            echo "- Update \`launch-unity\` to \`${NEW_VERSION}\`"
            echo "- Cli~ was at \`${CLI_VERSION}\`"
            echo "- TypeScriptServer~ was at \`${SERVER_VERSION}\`"
            echo ""
            echo "## CHANGELOG (launch-unity ${CLI_VERSION} â†’ ${NEW_VERSION})"
            echo ""
            cat /tmp/changelog-diff.txt
            echo ""
            echo "---"
            echo "Release: https://github.com/hatayama/LaunchUnityCommand/releases/tag/launch-unity-v${NEW_VERSION}"
          } > /tmp/pr-body.md

      - name: ðŸš€ Create Pull Request
        if: steps.check.outputs.skip == 'false'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: deps/update-launch-unity-${{ steps.version.outputs.new_version }}
          commit-message: "chore(deps): bump launch-unity to ${{ steps.version.outputs.new_version }}"
          title: "chore(deps): bump launch-unity to ${{ steps.version.outputs.new_version }}"
          body-path: /tmp/pr-body.md
          labels: dependencies,npm
